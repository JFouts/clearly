@using Clearly.Crud.WebUi.Client.Models.Dto
@using Clearly.Crud.WebUi.Client.Shared.DisplayComponents
@using Clearly.Crud.WebUi
@using Clearly.Crud.WebUi.Core
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq

@inherits BaseStringEditorComponent

@inject IDataSourceFactory dataSourceFactory
@inject IDataSourceReader<KeyValuePair<string, string>> dataSourceReader;

<div class="mb-3">
  <label for="@PropertyDefinitionNode.NameKey">@PropertyDefinitionNode.DisplayName</label>
  <select class="form-select" id="@PropertyDefinitionNode.NameKey" name="@PropertyDefinitionNode.NameKey" @bind="Value">
    @foreach (var option in Options)
    {
      <option value="@option.Value">@option.Label</option>  
    }
  </select> 
</div>

@code
{
    protected CrudAdminDropDownFeature Configuration { get; set; } = new CrudAdminDropDownFeature();

    protected IEnumerable<DropDownOption> Options { get; set; } = Array.Empty<DropDownOption>();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        Configuration = PropertyDefinitionNode.Features[nameof(CrudAdminDropDownFeature)].ToObject<CrudAdminDropDownFeature>();

        var dataSource = dataSourceFactory.Create(Configuration.DataSourceType, Configuration.DataSource);
        var data = await dataSourceReader.ReadFrom(dataSource);

        Options = data.Select(x => new DropDownOption
        {
            Value = x.Key,
            Label = x.Value,
        });
    }

    protected class DropDownOption
    {
        public string Value { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
    }
}